#!/usr/bin/env bash

set -eu

if [ -f "/etc/NIXOS" ]; then
  # Link dotfiles
    touch ~/.localrc
    ./init/stow
    exit
fi

# Source nix for the current session
if [ -f "/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh" ]; then
    . "/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh"
fi

# Install zsh via system package manager if not present
# (needed for chsh â€” nix-profile paths can't go in /etc/shells)
if ! command -v zsh >/dev/null 2>&1; then
    echo "Installing zsh via system package manager..."
    if [ "$(uname)" = "Darwin" ]; then
        echo "zsh ships with macOS"
    elif command -v apt >/dev/null 2>&1; then
        sudo apt install -y zsh
    elif command -v dnf >/dev/null 2>&1; then
        sudo dnf install -y zsh
    elif command -v pacman >/dev/null 2>&1; then
        sudo pacman -S --noconfirm zsh
    fi
fi

# Use Zsh
if [ "$(echo $SHELL)" != "$(command -v zsh)" ]; then
    echo "Switching to Zsh"
    ZSH_PATH="$(command -v zsh)"
    # Add to /etc/shells if not already there
    if ! grep -qx "$ZSH_PATH" /etc/shells; then
        echo "$ZSH_PATH" | sudo tee -a /etc/shells
    fi
    sudo chsh -s "$ZSH_PATH" "${USER}"
fi

# Detect platform for home-manager profile
USERNAME="$(whoami)"
if [ "$(uname)" = "Darwin" ]; then
    PROFILE="${USERNAME}@macos"
else
    PROFILE="${USERNAME}@linux"
fi

# Bootstrap home-manager and install all packages
echo "Running home-manager switch for profile: $PROFILE"
nix run home-manager -- switch --flake ~/dotfiles/nix#"$PROFILE"

# Link dotfiles
touch "$HOME"/.localrc
"$HOME"/dotfiles/init/stow
