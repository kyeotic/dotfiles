#!/bin/bash

# Run with
# /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/kyeotic/dotfiles/HEAD/init/install)"
# Test with
# wsl --install Ubuntu --name utest
#
# Safe to run multiple times â€” each step is idempotent.

set -u

# Install minimal dependencies (git + curl)
if [ "$(expr substr $(uname -s) 1 5)" = "Linux" ]; then
    if command -v apt >/dev/null 2>&1; then
        sudo apt update
        sudo apt install -y git curl
    elif command -v dnf >/dev/null 2>&1; then
        sudo dnf install -y git curl
    elif command -v pacman >/dev/null 2>&1; then
        sudo pacman -S --noconfirm git curl
    fi
fi

# Install Nix (Determinate Systems installer)
if ! command -v nix >/dev/null 2>&1; then
    echo "Installing Nix..."
    curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install --no-confirm
fi

# Source nix for the current session
if [ -f "/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh" ]; then
    . "/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh"
fi

# Clone repo if not present
if [ ! -d "$HOME/dotfiles/.git" ]; then
    cd $HOME
    git clone https://github.com/kyeotic/dotfiles.git
    cd dotfiles
    git remote set-url origin git@github.com:kyeotic/dotfiles.git
    ./init/setup-ssh
fi

$HOME/dotfiles/init/init
