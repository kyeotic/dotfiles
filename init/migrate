#!/usr/bin/env bash

# Migrate an existing machine from Homebrew to Nix + home-manager.
# Safe to run multiple times â€” each step is idempotent.

set -eu

# Install Nix if not present
if ! command -v nix >/dev/null 2>&1; then
    echo "Installing Nix..."
    curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install --no-confirm
fi

# Source nix for the current session
if [ -f "/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh" ]; then
    . "/nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh"
fi

# Detect profile
USERNAME="$(whoami)"
if [ "$(uname)" = "Darwin" ]; then
    if [ "$(uname -m)" = "arm64" ]; then
        PROFILE="${USERNAME}@macos"
    else
        PROFILE="${USERNAME}@macos-x86"
    fi
else
    PROFILE="${USERNAME}@linux"
fi

# Bootstrap home-manager and install all packages
echo "Running home-manager switch for profile: $PROFILE"
nix run home-manager -- switch --flake ~/dotfiles/nix#"$PROFILE"

# Re-stow dotfiles (picks up updated .starship-rc, .zsh_aliases, etc.)
echo "Re-linking dotfiles..."
~/dotfiles/init/stow

echo ""
echo "Migration complete. Open a new terminal to pick up all changes."
echo "After verifying, you can uninstall Homebrew with:"
echo '  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/uninstall.sh)"'
